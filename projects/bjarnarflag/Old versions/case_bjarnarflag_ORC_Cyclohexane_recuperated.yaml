# ==========================================================================
# BJARNARFLAG ORC - CYCLOHEXANE WITH RECUPERATOR
# ==========================================================================
# Based on successful fluid sweep optimization for simple cycle
# Now extended with recuperator for improved efficiency
# η_sys (simple) = 18.25%, Tc = 280.5°C (dry fluid)
# ==========================================================================

solver_options: 
  library: scipy
  method: slsqp
  derivative_method: 2-point 
  derivative_abs_step: 1e-6
  print_convergence: True 
  plot_convergence: False
  logger: None
  update_on: gradient
  tolerance: 1e-6 
  max_iterations: 200
  problem_scale: 20
  callbacks:
    save_plot: True
    save_config: True
    save_report: True
    plot_cycle: True
    plot_convergence: False


problem_formulation:

  cycle_topology: recuperated    # <-- Changed from 'simple'

  plot_settings:
    pinch_point_diagram: False
    fluid: 
      plot_saturation_line: True
      plot_critical_point: True
      plot_quality_isolines: True
      plot_pseudocritical_line: False
      plot_triple_point_liquid: False
      plot_triple_point_vapor: False
    diagrams:
      - x_prop: s
        y_prop: T
        x_scale: linear
        y_scale: linear


  fixed_parameters:

    # ==========================================================================
    # WORKING FLUID - CYCLOHEXANE
    # Tc = 280.5°C, pc = 40.8 bar
    # Type: Dry fluid - good for recuperated ORC (superheated turbine exhaust)
    # ==========================================================================
    working_fluid:
      name: CycloHexane
      backend: HEOS
      exceptions: True

    # ==========================================================================
    # HEAT SOURCE / SINK FLUIDS
    # ==========================================================================
    heating_fluid:
      name: water
      backend: HEOS
      exceptions: True

    cooling_fluid:
      name: water
      backend: HEOS
      exceptions: True

    # ==========================================================================
    # TARGET POWER OUTPUT
    # ==========================================================================
    net_power: 45e6

    # ==========================================================================
    # SPECIAL POINTS
    # ==========================================================================
    special_points:
      ambient_pressure: 101325
      ambient_temperature: 293.15
      maximum_temperature: 451.25

    # ==========================================================================
    # HEAT SOURCE: Bjarnarflag Brine
    # ==========================================================================
    heat_source:
      inlet_temperature: 451.25           # 178.1°C in Kelvin
      minimum_temperature: 373.15         # 100°C minimum reinjection
      inlet_pressure: 1824863.25          # 18.01 bar
      exit_pressure: 1824863.25

    # ==========================================================================
    # HEAT SINK
    # ==========================================================================
    heat_sink:
      inlet_temperature: 293.15           # 20°C
      inlet_pressure: 101325
      exit_pressure: 101325

    # ==========================================================================
    # HEAT EXCHANGERS
    # ==========================================================================
    heater:
      pressure_drop_hot_side: 0.01
      pressure_drop_cold_side: 0.01
      num_elements: 25

    cooler:
      pressure_drop_hot_side: 0.01
      pressure_drop_cold_side: 0.01
      num_elements: 25

    # ==========================================================================
    # RECUPERATOR (Internal Heat Exchanger)  <-- NEW COMPONENT
    # Recovers heat from turbine exhaust to preheat working fluid after pump
    # This is beneficial for dry fluids like Cyclohexane because turbine
    # exhaust is superheated and contains recoverable energy.
    # ==========================================================================
    recuperator:
      pressure_drop_hot_side: 0.01
      pressure_drop_cold_side: 0.01
      num_elements: 25

    # ==========================================================================
    # TURBOMACHINERY
    # ==========================================================================
    expander:
      efficiency: 0.90
      efficiency_type: isentropic

    compressor:
      efficiency: 0.85
      efficiency_type: isentropic

    heat_source_pump:
      efficiency: 0.80
      efficiency_type: isentropic

    heat_sink_pump:
      efficiency: 0.80
      efficiency_type: isentropic


  # ============================================================================
  # DESIGN VARIABLES - From successful fluid sweep + recuperator effectiveness
  # ============================================================================
  design_variables:
    heat_source_exit_temperature:
      min: 373.15
      max: 446.25
      value: 373.15

    heat_sink_exit_temperature:
      min: 296.15
      max: 308.15
      value: 296.15

    compressor_inlet_pressure:
      min: 12367.92
      max: 38080.55
      value: 14434.67

    compressor_inlet_enthalpy:
      min: -141055.66
      max: -63083.12
      value: -108614.27

    expander_inlet_pressure:
      min: 51935.77
      max: 856017.04
      value: 344007.85

    expander_inlet_enthalpy:
      min: 327133.17
      max: 502617.20
      value: 441847.72

    # ==========================================================================
    # RECUPERATOR EFFECTIVENESS  <-- NEW DESIGN VARIABLE
    # 0.0 = no heat recovery (same as simple cycle)
    # 1.0 = maximum possible heat recovery (limited by pinch)
    # ==========================================================================
    recuperator_effectiveness:
      min: 0.0
      max: 1.0
      value: 0.8    # Start with 80% effectiveness


  # ============================================================================
  # CONSTRAINTS
  # ============================================================================
  constraints:
    - variable: $components.heater.temperature_difference
      type: ">"
      value: 5
      normalize: True

    - variable: $components.cooler.temperature_difference
      type: ">"
      value: 5
      normalize: True

    # ==========================================================================
    # RECUPERATOR PINCH CONSTRAINT  <-- NEW CONSTRAINT
    # ==========================================================================
    - variable: $components.recuperator.temperature_difference
      type: ">"
      value: 5
      normalize: True

    - variable: $components.compressor.state_in.subcooling
      type: ">"
      value: 1.0
      normalize: True

    - variable: $components.expander.state_in.superheating
      type: ">"
      value: 5


  # ============================================================================
  # OBJECTIVE FUNCTION
  # ============================================================================
  objective_function:
    variable: $energy_analysis.system_efficiency
    type: maximize
